<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analizador de Fertilidad - Trigo, Ma칤z, Soja, Sorgo, Girasol</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        #map {
            height: 100vh;
            width: 100%;
        }
        
        .control-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            width: 350px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            color: white;
            flex-direction: column;
        }
        
        .parameter-badge {
            font-size: 0.8em;
            padding: 4px 8px;
        }
        
        .btn-group-vertical {
            width: 100%;
        }
        
        .results-section {
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div class="control-panel">
        <div class="text-center mb-4">
            <h4 class="text-success">游꺔 Analizador de Fertilidad</h4>
            <p class="text-muted small">Selecciona cultivo y dibuja un pol칤gono</p>
        </div>
        
        <div class="mb-3">
            <label class="form-label">Cultivo:</label>
            <select id="crop-select" class="form-select">
                <option value="trigo">Trigo</option>
                <option value="maiz">Ma칤z</option>
                <option value="soja">Soja</option>
                <option value="sorgo">Sorgo</option>
                <option value="girasol">Girasol</option>
            </select>
        </div>
        
        <div class="btn-group-vertical gap-2 mb-3">
            <button id="draw-polygon" class="btn btn-primary">
                <i class="bi bi-pencil"></i> Dibujar Pol칤gono
            </button>
            <button id="analyze" class="btn btn-success" disabled>
                <i class="bi bi-graph-up"></i> Analizar Fertilidad
            </button>
            <button id="export-geojson" class="btn btn-info" disabled>
                <i class="bi bi-download"></i> Exportar GeoJSON
            </button>
            <button id="clear-all" class="btn btn-danger">
                <i class="bi bi-trash"></i> Limpiar Mapa
            </button>
        </div>
        
        <div id="area-info" class="alert alert-info py-2" style="display: none;">
            <small><strong>츼rea:</strong> <span id="area-value">0</span> hect치reas</small>
        </div>
        
        <div id="analysis-results" class="mt-3" style="display: none;">
            <h6 class="border-bottom pb-2">Resultados del An치lisis</h6>
            <div id="results-content" class="results-section">
                <!-- Los resultados se cargar치n aqu칤 -->
            </div>
        </div>
        
        <div class="mt-3">
            <label class="form-label small">Mapa Base:</label>
            <select id="base-map" class="form-select form-select-sm">
                <option value="esri-imagery">ESRI Sat칠lite</option>
                <option value="esri-topo">ESRI Topogr치fico</option>
                <option value="osm">OpenStreetMap</option>
            </select>
        </div>
    </div>

    <div id="loading" class="loading-overlay">
        <div class="spinner-border mb-3" role="status">
            <span class="visually-hidden">Cargando...</span>
        </div>
        <p>Analizando fertilidad...</p>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
    
    <script>
        // Configuraci칩n del mapa
        const map = L.map('map').setView([-34.6037, -58.3816], 13);
        
        // Capas base
        const baseLayers = {
            'esri-imagery': L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
            }),
            'esri-topo': L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri &mdash; Esri, DeLorme, NAVTEQ, TomTom, Intermap, iPC, USGS, FAO, NPS, NRCAN, GeoBase, Kadaster NL, Ordnance Survey, Esri Japan, METI, Esri China (Hong Kong), and the GIS User Community'
            }),
            'osm': L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            })
        };
        
        baseLayers['esri-imagery'].addTo(map);
        
        // Control de capas base
        document.getElementById('base-map').addEventListener('change', function(e) {
            Object.values(baseLayers).forEach(layer => map.removeLayer(layer));
            baseLayers[e.target.value].addTo(map);
        });
        
        // Variables globales
        let drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);
        let currentPolygon = null;
        
        // Control de dibujo
        const drawControl = new L.Control.Draw({
            draw: {
                polygon: {
                    allowIntersection: false,
                    shapeOptions: {
                        color: '#4CAF50',
                        fillColor: '#4CAF50',
                        fillOpacity: 0.2,
                        weight: 3
                    }
                },
                polyline: false,
                rectangle: false,
                circle: false,
                marker: false
            },
            edit: {
                featureGroup: drawnItems
            }
        });
        map.addControl(drawControl);
        
        // Eventos de dibujo
        map.on(L.Draw.Event.CREATED, function (event) {
            const layer = event.layer;
            drawnItems.addLayer(layer);
            currentPolygon = layer;
            
            // Calcular 치rea
            const area = turf.area(layer.toGeoJSON());
            const areaHectares = (area / 10000).toFixed(2);
            
            document.getElementById('area-value').textContent = areaHectares;
            document.getElementById('area-info').style.display = 'block';
            
            updateUI();
        });
        
        // Actualizar UI
        function updateUI() {
            const hasPolygons = drawnItems.getLayers().length > 0;
            document.getElementById('analyze').disabled = !hasPolygons;
            document.getElementById('export-geojson').disabled = !hasPolygons;
        }
        
        // An치lisis de fertilidad
        document.getElementById('analyze').addEventListener('click', function() {
            if (!currentPolygon) {
                alert('Por favor, dibuja un pol칤gono primero.');
                return;
            }
            
            const crop = document.getElementById('crop-select').value;
            const geojson = currentPolygon.toGeoJSON();
            
            showLoading(true);
            
            fetch('/analyze', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    geojson: geojson,
                    crop: crop
                })
            })
            .then(response => response.json())
            .then(data => {
                showLoading(false);
                if (data.success) {
                    displayResults(data.result);
                } else {
                    alert('Error en el an치lisis: ' + data.error);
                }
            })
            .catch(error => {
                showLoading(false);
                alert('Error de conexi칩n: ' + error);
            });
        });
        
        // Exportar GeoJSON
        document.getElementById('export-geojson').addEventListener('click', function() {
            if (!currentPolygon) {
                alert('No hay pol칤gonos para exportar.');
                return;
            }
            
            const crop = document.getElementById('crop-select').value;
            const geojson = currentPolygon.toGeoJSON();
            
            fetch('/export', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    geojson: geojson,
                    crop: crop
                })
            })
            .then(response => response.blob())
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = `fertilidad_${crop}_${new Date().toISOString().split('T')[0]}.geojson`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
            })
            .catch(error => {
                alert('Error en la exportaci칩n: ' + error);
            });
        });
        
        // Limpiar mapa
        document.getElementById('clear-all').addEventListener('click', function() {
            drawnItems.clearLayers();
            currentPolygon = null;
            document.getElementById('area-info').style.display = 'none';
            document.getElementById('analysis-results').style.display = 'none';
            updateUI();
        });
        
        // Mostrar/ocultar loading
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'flex' : 'none';
        }
        
        // Mostrar resultados
        function displayResults(results) {
            const content = document.getElementById('results-content');
            const resultsDiv = document.getElementById('analysis-results');
            
            const cropNames = {
                'trigo': 'Trigo',
                'maiz': 'Ma칤z',
                'soja': 'Soja',
                'sorgo': 'Sorgo',
                'girasol': 'Girasol'
            };
            
            content.innerHTML = `
                <div class="mb-3">
                    <strong>Cultivo:</strong> ${cropNames[results.crop]}<br>
                    <strong>츼rea:</strong> ${results.area_hectareas} hect치reas
                </div>
                
                <h6 class="mt-3">Par치metros del Suelo:</h6>
                <div class="row g-1 mb-3">
                    <div class="col-6">
                        <span class="badge bg-${getBadgeColor(results.parametros.nitrogeno)} parameter-badge">N: ${results.parametros.nitrogeno}</span>
                    </div>
                    <div class="col-6">
                        <span class="badge bg-${getBadgeColor(results.parametros.fosforo)} parameter-badge">P: ${results.parametros.fosforo}</span>
                    </div>
                    <div class="col-6">
                        <span class="badge bg-${getBadgeColor(results.parametros.potasio)} parameter-badge">K: ${results.parametros.potasio}</span>
                    </div>
                    <div class="col-6">
                        <span class="badge bg-secondary parameter-badge">pH: ${results.parametros.ph}</span>
                    </div>
                    <div class="col-12">
                        <span class="badge bg-dark parameter-badge">MO: ${results.parametros.materia_organica}%</span>
                    </div>
                </div>
                
                <h6 class="mt-3">Recomendaciones:</h6>
                <ul class="small">
                    ${results.recomendaciones.map(rec => `<li>${rec}</li>`).join('')}
                </ul>
            `;
            
            resultsDiv.style.display = 'block';
        }
        
        function getBadgeColor(value) {
            switch(value) {
                case 'bajo': return 'danger';
                case 'medio': return 'warning';
                case 'alto': return 'success';
                case 'muy_alto': return 'success';
                default: return 'secondary';
            }
        }
        
        // Iniciar dibujo
        document.getElementById('draw-polygon').addEventListener('click', function() {
            new L.Draw.Polygon(map, drawControl.options.draw.polygon).enable();
        });
        
        // Inicializar UI
        updateUI();
    </script>
</body>
</html>
